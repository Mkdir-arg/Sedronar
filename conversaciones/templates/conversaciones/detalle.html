{% extends 'includes/base.html' %}
{% load static %}

{% block title %}Conversación #{{ conversacion.id }}{% endblock %}

{% block main-content %}
<div class="space-y-6" x-data="chatOperador()">
    <!-- Header -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">Conversación #{{ conversacion.id }}</h1>
                <div class="flex items-center gap-4 mt-2">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                        {% if conversacion.tipo == 'personal' %}bg-green-100 text-green-800{% else %}bg-blue-100 text-blue-800{% endif %}">
                        {{ conversacion.get_tipo_display }}
                    </span>
                    {% if conversacion.dni_ciudadano %}
                        <span class="text-sm text-gray-600">DNI: {{ conversacion.dni_ciudadano }}</span>
                    {% endif %}
                    <span class="text-sm text-gray-600">{{ conversacion.fecha_inicio|date:"d/m/Y H:i" }}</span>
                </div>
            </div>
            <div class="flex gap-2">
                <a href="{% url 'conversaciones:lista' %}" 
                   class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                    <i class="fas fa-arrow-left mr-2"></i>Volver
                </a>
                {% if conversacion.estado == 'activa' %}
                <a href="{% url 'conversaciones:cerrar' conversacion.id %}" 
                   class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors"
                   onclick="return confirm('¿Estás seguro de cerrar esta conversación?')">
                    <i class="fas fa-times mr-2"></i>Cerrar
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Chat -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col h-96">
        <!-- Mensajes -->
        <div class="flex-1 overflow-y-auto p-6 space-y-4" x-ref="mensajesContainer">
            {% for mensaje in mensajes %}
            <div class="flex {% if mensaje.remitente == 'operador' %}justify-end{% else %}justify-start{% endif %}">
                <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-lg
                    {% if mensaje.remitente == 'operador' %}bg-blue-500 text-white{% else %}bg-gray-200 text-gray-800{% endif %}">
                    <p>{{ mensaje.contenido }}</p>
                    <p class="text-xs opacity-70 mt-1">
                        {% if mensaje.remitente == 'operador' %}
                            Tú - {{ mensaje.fecha_envio|date:"H:i" }}
                        {% else %}
                            Ciudadano - {{ mensaje.fecha_envio|date:"H:i" }}
                        {% endif %}
                    </p>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- Input de respuesta -->
        {% if conversacion.estado == 'activa' and conversacion.operador_asignado == request.user %}
        <div class="border-t p-4">
            <div class="flex gap-2">
                <input x-model="nuevoMensaje" @keyup.enter="enviarMensaje()" 
                       type="text" placeholder="Escribe tu respuesta..."
                       class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button @click="enviarMensaje()" 
                        class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                    Enviar
                </button>
            </div>
        </div>
        {% elif conversacion.estado == 'activa' and not conversacion.operador_asignado %}
        <div class="border-t p-4 bg-yellow-50">
            <p class="text-center text-yellow-700">Esta conversación no está asignada</p>
        </div>
        {% elif conversacion.estado == 'activa' and conversacion.operador_asignado != request.user %}
        <div class="border-t p-4 bg-gray-50">
            <p class="text-center text-gray-500">Esta conversación está asignada a {{ conversacion.operador_asignado.get_full_name }}</p>
        </div>
        {% else %}
        <div class="border-t p-4 bg-gray-50">
            <p class="text-center text-gray-500">Esta conversación está cerrada</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
    function chatOperador() {
        return {
            nuevoMensaje: '',
            conversacionId: {{ conversacion.id }},
            socket: null,
            
            init() {
                this.$nextTick(() => {
                    this.scrollToBottom();
                    this.conectarWebSocket();
                });
            },
            
            conectarWebSocket() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                // Ruta WebSocket debe coincidir con routing.py: ws/conversaciones/<id>/
                const wsUrl = `${protocol}//${window.location.host}/ws/conversaciones/${this.conversacionId}/`;
                
                this.socket = new WebSocket(wsUrl);
                
                this.socket.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    if (data.type === 'mensaje') {
                        this.agregarMensajeCiudadano(data.mensaje);
                    }
                };
                
                this.socket.onerror = (error) => {
                    console.error('WebSocket error:', error);
                };
                
                this.socket.onclose = () => {
                    console.log('WebSocket cerrado, reconectando...');
                    setTimeout(() => this.conectarWebSocket(), 3000);
                };
            },
            
            agregarMensajeCiudadano(mensaje) {
                if (mensaje.remitente === 'ciudadano') {
                    const container = this.$refs.mensajesContainer;
                    const mensajeDiv = document.createElement('div');
                    mensajeDiv.className = 'flex justify-start';
                    
                    mensajeDiv.innerHTML = `
                        <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-lg bg-gray-200 text-gray-800">
                            <p>${mensaje.contenido}</p>
                            <p class="text-xs opacity-70 mt-1">Ciudadano - ${mensaje.fecha}</p>
                        </div>
                    `;
                    
                    container.appendChild(mensajeDiv);
                    this.scrollToBottom();
                }
            },
            
            async enviarMensaje() {
                if (!this.nuevoMensaje.trim()) return;
                
                try {
                    const response = await fetch(`/conversaciones/${this.conversacionId}/responder/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            mensaje: this.nuevoMensaje
                        })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        this.agregarMensajeOperador(data.mensaje);
                        this.nuevoMensaje = '';
                    } else {
                        alert('Error al enviar mensaje: ' + (data.error || 'Error desconocido'));
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error al enviar mensaje');
                }
            },
            
            agregarMensajeOperador(mensaje) {
                const container = this.$refs.mensajesContainer;
                const mensajeDiv = document.createElement('div');
                mensajeDiv.className = 'flex justify-end';
                
                mensajeDiv.innerHTML = `
                    <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-lg bg-blue-500 text-white">
                        <p>${mensaje.contenido}</p>
                        <p class="text-xs opacity-70 mt-1">Tú - ${mensaje.fecha}</p>
                    </div>
                `;
                
                container.appendChild(mensajeDiv);
                this.scrollToBottom();
            },
            
            scrollToBottom() {
                const container = this.$refs.mensajesContainer;
                if (container) {
                    container.scrollTop = container.scrollHeight;
                }
            }
        }
    }
</script>
{% endblock main-content %}
