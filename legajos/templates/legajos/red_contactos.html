{% extends "includes/base.html" %}
{% load static %}

{% block title %}Red de Contactos - {{ legajo.ciudadano }}{% endblock %}

{% block extra_css %}
<style>
.network-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
}

.network-card:hover {
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    transform: translateY(-2px);
}

.contact-node {
    position: relative;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 50%;
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    margin: 0 auto 1rem;
}

.contact-node.central {
    width: 80px;
    height: 80px;
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
}

.contact-node.family {
    background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
}

.contact-node.professional {
    background: linear-gradient(135deg, #45b7d1 0%, #96c93d 100%);
}

.contact-node.emergency {
    background: linear-gradient(135deg, #fd79a8 0%, #fdcb6e 100%);
}

.priority-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #e74c3c;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.connection-line {
    height: 2px;
    background: linear-gradient(90deg, #ddd 0%, #999 50%, #ddd 100%);
    margin: 1rem 0;
}

.tab-content {
    min-height: 400px;
}

.empty-state {
    text-align: center;
    padding: 3rem;
    color: #6c757d;
}

.network-stats {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1.5rem;
}

.role-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
}

.role-PSICOLOGO { background-color: #e3f2fd; color: #1976d2; }
.role-PSIQUIATRA { background-color: #f3e5f5; color: #7b1fa2; }
.role-MEDICO { background-color: #e8f5e8; color: #388e3c; }
.role-TRABAJADOR_SOCIAL { background-color: #fff3e0; color: #f57c00; }
.role-OPERADOR { background-color: #fce4ec; color: #c2185b; }
.role-COORDINADOR { background-color: #e0f2f1; color: #00695c; }
.role-DIRECTOR { background-color: #f1f8e9; color: #558b2f; }
.role-ENFERMERO { background-color: #e8eaf6; color: #3f51b5; }
.role-TERAPISTA { background-color: #fff8e1; color: #ff8f00; }
.role-ABOGADO { background-color: #efebe9; color: #5d4037; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">Red de Contactos</h1>
                    <p class="text-muted mb-0">
                        <strong>{{ legajo.ciudadano }}</strong> - Legajo: {{ legajo.codigo|slice:":8" }}...
                    </p>
                </div>
                <div>
                    <a href="{% url 'legajos:detalle' legajo.id %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Volver al Legajo
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Estadísticas de Red -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="network-stats">
                <div class="row text-center">
                    <div class="col-md-3">
                        <h4 class="mb-1" id="total-vinculos">-</h4>
                        <small class="text-muted">Vínculos Familiares</small>
                    </div>
                    <div class="col-md-3">
                        <h4 class="mb-1" id="total-profesionales">-</h4>
                        <small class="text-muted">Profesionales</small>
                    </div>
                    <div class="col-md-3">
                        <h4 class="mb-1" id="total-dispositivos">-</h4>
                        <small class="text-muted">Dispositivos</small>
                    </div>
                    <div class="col-md-3">
                        <h4 class="mb-1" id="total-emergencias">-</h4>
                        <small class="text-muted">Contactos Emergencia</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs de Navegación -->
    <div class="row">
        <div class="col-12">
            <ul class="nav nav-tabs" id="redTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="vinculos-tab" data-bs-toggle="tab" data-bs-target="#vinculos" type="button">
                        <i class="fas fa-users me-2"></i>Vínculos Familiares
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="profesionales-tab" data-bs-toggle="tab" data-bs-target="#profesionales" type="button">
                        <i class="fas fa-user-md me-2"></i>Equipo Tratante
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="dispositivos-tab" data-bs-toggle="tab" data-bs-target="#dispositivos" type="button">
                        <i class="fas fa-building me-2"></i>Dispositivos
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="emergencias-tab" data-bs-toggle="tab" data-bs-target="#emergencias" type="button">
                        <i class="fas fa-phone-alt me-2"></i>Emergencias
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="redTabContent">
                <!-- Tab Vínculos Familiares -->
                <div class="tab-pane fade show active" id="vinculos" role="tabpanel">
                    <div class="network-card p-4 mt-3">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">Red Familiar</h5>
                            <button class="btn btn-primary btn-sm" onclick="abrirModalVinculo()">
                                <i class="fas fa-plus"></i> Agregar Vínculo
                            </button>
                        </div>
                        <div id="vinculos-container">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status"></div>
                                <p class="mt-2 text-muted">Cargando vínculos...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Profesionales -->
                <div class="tab-pane fade" id="profesionales" role="tabpanel">
                    <div class="network-card p-4 mt-3">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">Equipo Interdisciplinario</h5>
                            <button class="btn btn-primary btn-sm" onclick="abrirModalProfesional()">
                                <i class="fas fa-plus"></i> Asignar Profesional
                            </button>
                        </div>
                        <div id="profesionales-container">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status"></div>
                                <p class="mt-2 text-muted">Cargando profesionales...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Dispositivos -->
                <div class="tab-pane fade" id="dispositivos" role="tabpanel">
                    <div class="network-card p-4 mt-3">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">Dispositivos Vinculados</h5>
                        </div>
                        <div id="dispositivos-container">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status"></div>
                                <p class="mt-2 text-muted">Cargando dispositivos...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Emergencias -->
                <div class="tab-pane fade" id="emergencias" role="tabpanel">
                    <div class="network-card p-4 mt-3">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">Contactos de Emergencia</h5>
                            <button class="btn btn-danger btn-sm" onclick="abrirModalEmergencia()">
                                <i class="fas fa-plus"></i> Agregar Contacto
                            </button>
                        </div>
                        <div id="emergencias-container">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status"></div>
                                <p class="mt-2 text-muted">Cargando contactos...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nuevo Vínculo -->
<div class="modal fade" id="modalVinculo" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Agregar Vínculo Familiar</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="formVinculo">
                <div class="modal-body">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Buscar Ciudadano *</label>
                        <input type="text" class="form-control" id="buscarCiudadano" placeholder="Nombre, apellido o DNI...">
                        <input type="hidden" name="ciudadano_vinculado" id="ciudadanoVinculadoId">
                        <div id="resultadosCiudadanos" class="mt-2"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tipo de Vínculo *</label>
                        <select class="form-select" name="tipo_vinculo" required>
                            <option value="">Seleccionar...</option>
                            <option value="PADRE">Padre</option>
                            <option value="MADRE">Madre</option>
                            <option value="HIJO">Hijo/a</option>
                            <option value="HERMANO">Hermano/a</option>
                            <option value="ABUELO">Abuelo/a</option>
                            <option value="TIO">Tío/a</option>
                            <option value="PRIMO">Primo/a</option>
                            <option value="PAREJA">Pareja</option>
                            <option value="EXPAREJA">Ex pareja</option>
                            <option value="CUÑADO">Cuñado/a</option>
                            <option value="YERNO">Yerno/Nuera</option>
                            <option value="SUEGRO">Suegro/a</option>
                            <option value="AMIGO">Amigo/a</option>
                            <option value="VECINO">Vecino/a</option>
                            <option value="REFERENTE">Referente comunitario</option>
                            <option value="TUTOR">Tutor legal</option>
                            <option value="OTRO">Otro</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="es_contacto_emergencia">
                                <label class="form-check-label">Contacto Emergencia</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="es_referente_tratamiento">
                                <label class="form-check-label">Referente Tratamiento</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="convive">
                                <label class="form-check-label">Convive</label>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Teléfono Alternativo</label>
                        <input type="text" class="form-control" name="telefono_alternativo">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Observaciones</label>
                        <textarea class="form-control" name="observaciones" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Vínculo</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Nuevo Profesional -->
<div class="modal fade" id="modalProfesional" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Asignar Profesional</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="formProfesional">
                <div class="modal-body">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Buscar Usuario *</label>
                        <input type="text" class="form-control" id="buscarUsuario" placeholder="Nombre o usuario...">
                        <input type="hidden" name="usuario" id="usuarioId">
                        <div id="resultadosUsuarios" class="mt-2"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Rol *</label>
                        <select class="form-select" name="rol" required>
                            <option value="">Seleccionar...</option>
                            <option value="PSICOLOGO">Psicólogo/a</option>
                            <option value="PSIQUIATRA">Psiquiatra</option>
                            <option value="MEDICO">Médico/a</option>
                            <option value="TRABAJADOR_SOCIAL">Trabajador/a Social</option>
                            <option value="OPERADOR">Operador/a Socioterapéutico</option>
                            <option value="COORDINADOR">Coordinador/a</option>
                            <option value="DIRECTOR">Director/a</option>
                            <option value="ENFERMERO">Enfermero/a</option>
                            <option value="TERAPISTA">Terapista Ocupacional</option>
                            <option value="ABOGADO">Abogado/a</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Dispositivo *</label>
                        <select class="form-select" name="dispositivo" required>
                            <option value="{{ legajo.dispositivo.id }}">{{ legajo.dispositivo.nombre }}</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="es_responsable_principal">
                            <label class="form-check-label">Responsable Principal</label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Observaciones</label>
                        <textarea class="form-control" name="observaciones" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Asignar Profesional</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Contacto Emergencia -->
<div class="modal fade" id="modalEmergencia" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Agregar Contacto de Emergencia</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="formEmergencia">
                <div class="modal-body">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Nombre Completo *</label>
                        <input type="text" class="form-control" name="nombre" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Relación *</label>
                        <input type="text" class="form-control" name="relacion" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Teléfono Principal *</label>
                                <input type="text" class="form-control" name="telefono_principal" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Teléfono Alternativo</label>
                                <input type="text" class="form-control" name="telefono_alternativo">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" name="email">
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Prioridad *</label>
                                <select class="form-select" name="prioridad" required>
                                    <option value="1">1 - Máxima prioridad</option>
                                    <option value="2">2 - Alta prioridad</option>
                                    <option value="3">3 - Prioridad media</option>
                                    <option value="4">4 - Baja prioridad</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="form-check mt-4">
                                    <input class="form-check-input" type="checkbox" name="disponibilidad_24hs" checked>
                                    <label class="form-check-label">Disponible 24hs</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Instrucciones Especiales</label>
                        <textarea class="form-control" name="instrucciones_especiales" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Guardar Contacto</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const legajoId = '{{ legajo.id }}';
let vinculos = [];
let profesionales = [];
let dispositivos = [];
let emergencias = [];

// Inicializar
document.addEventListener('DOMContentLoaded', function() {
    cargarDatos();
    configurarBusquedas();
    configurarFormularios();
});

// Cargar todos los datos
function cargarDatos() {
    cargarVinculos();
    cargarProfesionales();
    cargarDispositivos();
    cargarEmergencias();
}

// Cargar vínculos familiares
function cargarVinculos() {
    fetch(`/legajos/${legajoId}/red-contactos/vinculos/`)
        .then(response => response.json())
        .then(data => {
            vinculos = data.vinculos;
            renderVinculos();
            actualizarEstadisticas();
        })
        .catch(error => console.error('Error:', error));
}

// Cargar profesionales
function cargarProfesionales() {
    fetch(`/legajos/${legajoId}/red-contactos/profesionales/`)
        .then(response => response.json())
        .then(data => {
            profesionales = data.profesionales;
            renderProfesionales();
            actualizarEstadisticas();
        })
        .catch(error => console.error('Error:', error));
}

// Cargar dispositivos
function cargarDispositivos() {
    fetch(`/legajos/${legajoId}/red-contactos/dispositivos/`)
        .then(response => response.json())
        .then(data => {
            dispositivos = data.dispositivos;
            renderDispositivos();
            actualizarEstadisticas();
        })
        .catch(error => console.error('Error:', error));
}

// Cargar emergencias
function cargarEmergencias() {
    fetch(`/legajos/${legajoId}/red-contactos/emergencias/`)
        .then(response => response.json())
        .then(data => {
            emergencias = data.contactos_emergencia;
            renderEmergencias();
            actualizarEstadisticas();
        })
        .catch(error => console.error('Error:', error));
}

// Renderizar vínculos
function renderVinculos() {
    const container = document.getElementById('vinculos-container');
    
    if (vinculos.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-users fa-3x mb-3"></i>
                <h5>No hay vínculos familiares registrados</h5>
                <p>Agrega vínculos familiares para crear la red de apoyo del ciudadano</p>
            </div>
        `;
        return;
    }
    
    let html = '<div class="row">';
    vinculos.forEach(vinculo => {
        const iniciales = `${vinculo.ciudadano_vinculado.nombre[0]}${vinculo.ciudadano_vinculado.apellido[0]}`;
        html += `
            <div class="col-md-4 mb-3">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <div class="contact-node family">
                            ${iniciales}
                        </div>
                        <h6 class="card-title">${vinculo.ciudadano_vinculado.nombre} ${vinculo.ciudadano_vinculado.apellido}</h6>
                        <p class="card-text">
                            <span class="badge bg-primary">${vinculo.tipo_vinculo_display}</span>
                        </p>
                        <div class="d-flex justify-content-center gap-1 mb-2">
                            ${vinculo.es_contacto_emergencia ? '<span class="badge bg-danger">Emergencia</span>' : ''}
                            ${vinculo.es_referente_tratamiento ? '<span class="badge bg-success">Referente</span>' : ''}
                            ${vinculo.convive ? '<span class="badge bg-info">Convive</span>' : ''}
                        </div>
                        <small class="text-muted">DNI: ${vinculo.ciudadano_vinculado.dni}</small>
                        ${vinculo.ciudadano_vinculado.telefono ? `<br><small class="text-muted">${vinculo.ciudadano_vinculado.telefono}</small>` : ''}
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    container.innerHTML = html;
}

// Renderizar profesionales
function renderProfesionales() {
    const container = document.getElementById('profesionales-container');
    
    if (profesionales.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-user-md fa-3x mb-3"></i>
                <h5>No hay profesionales asignados</h5>
                <p>Asigna profesionales para formar el equipo interdisciplinario</p>
            </div>
        `;
        return;
    }
    
    let html = '<div class="row">';
    profesionales.forEach(prof => {
        const iniciales = prof.usuario.nombre.split(' ').map(n => n[0]).join('');
        html += `
            <div class="col-md-6 mb-3">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="contact-node professional me-3">
                                ${iniciales}
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-1">${prof.usuario.nombre}</h6>
                                <span class="role-badge role-${prof.rol}">${prof.rol_display}</span>
                                ${prof.es_responsable_principal ? '<span class="badge bg-warning ms-1">Principal</span>' : ''}
                                <p class="mb-1 mt-2"><small class="text-muted">${prof.dispositivo.nombre}</small></p>
                                <p class="mb-0"><small class="text-muted">Desde: ${new Date(prof.fecha_asignacion).toLocaleDateString()}</small></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    container.innerHTML = html;
}

// Renderizar dispositivos
function renderDispositivos() {
    const container = document.getElementById('dispositivos-container');
    
    if (dispositivos.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-building fa-3x mb-3"></i>
                <h5>No hay dispositivos vinculados</h5>
                <p>Los dispositivos se vinculan automáticamente durante el proceso de admisión</p>
            </div>
        `;
        return;
    }
    
    let html = '<div class="row">';
    dispositivos.forEach(disp => {
        const fechaAdmision = new Date(disp.fecha_admision).toLocaleDateString();
        const fechaEgreso = disp.fecha_egreso ? new Date(disp.fecha_egreso).toLocaleDateString() : null;
        
        html += `
            <div class="col-md-6 mb-3">
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="card-title">${disp.dispositivo.nombre}</h6>
                        <p class="card-text">
                            <span class="badge bg-secondary">${disp.dispositivo.tipo}</span>
                            <span class="badge ${getEstadoBadgeClass(disp.estado)}">${disp.estado_display}</span>
                        </p>
                        <p class="mb-1"><small class="text-muted">Admisión: ${fechaAdmision}</small></p>
                        ${fechaEgreso ? `<p class="mb-1"><small class="text-muted">Egreso: ${fechaEgreso}</small></p>` : ''}
                        ${disp.referente ? `<p class="mb-1"><small class="text-muted">Referente: ${disp.referente}</small></p>` : ''}
                        ${disp.dispositivo.direccion ? `<p class="mb-0"><small class="text-muted">${disp.dispositivo.direccion}</small></p>` : ''}
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    container.innerHTML = html;
}

// Renderizar emergencias
function renderEmergencias() {
    const container = document.getElementById('emergencias-container');
    
    if (emergencias.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-phone-alt fa-3x mb-3"></i>
                <h5>No hay contactos de emergencia</h5>
                <p>Agrega contactos de emergencia para situaciones críticas</p>
            </div>
        `;
        return;
    }
    
    let html = '<div class="row">';
    emergencias.forEach(contacto => {
        const iniciales = contacto.nombre.split(' ').map(n => n[0]).join('');
        html += `
            <div class="col-md-6 mb-3">
                <div class="card h-100 border-danger">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="contact-node emergency me-3">
                                ${iniciales}
                                <div class="priority-badge">${contacto.prioridad}</div>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-1">${contacto.nombre}</h6>
                                <p class="mb-1">${contacto.relacion}</p>
                                <p class="mb-1"><strong>${contacto.telefono_principal}</strong></p>
                                ${contacto.telefono_alternativo ? `<p class="mb-1"><small>${contacto.telefono_alternativo}</small></p>` : ''}
                                ${contacto.disponibilidad_24hs ? '<span class="badge bg-success">24hs</span>' : '<span class="badge bg-warning">Horario limitado</span>'}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    container.innerHTML = html;
}

// Actualizar estadísticas
function actualizarEstadisticas() {
    document.getElementById('total-vinculos').textContent = vinculos.length;
    document.getElementById('total-profesionales').textContent = profesionales.length;
    document.getElementById('total-dispositivos').textContent = dispositivos.length;
    document.getElementById('total-emergencias').textContent = emergencias.length;
}

// Configurar búsquedas
function configurarBusquedas() {
    // Búsqueda de ciudadanos
    let timeoutCiudadanos;
    document.getElementById('buscarCiudadano').addEventListener('input', function() {
        clearTimeout(timeoutCiudadanos);
        const query = this.value;
        
        if (query.length < 2) {
            document.getElementById('resultadosCiudadanos').innerHTML = '';
            return;
        }
        
        timeoutCiudadanos = setTimeout(() => {
            fetch(`/legajos/red-contactos/buscar-ciudadanos/?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    let html = '';
                    data.ciudadanos.forEach(ciudadano => {
                        html += `
                            <div class="list-group-item list-group-item-action" onclick="seleccionarCiudadano(${ciudadano.id}, '${ciudadano.nombre_completo}')">
                                <strong>${ciudadano.nombre_completo}</strong><br>
                                <small>DNI: ${ciudadano.dni} ${ciudadano.telefono ? '• Tel: ' + ciudadano.telefono : ''}</small>
                            </div>
                        `;
                    });
                    document.getElementById('resultadosCiudadanos').innerHTML = html ? `<div class="list-group">${html}</div>` : '';
                })
                .catch(error => console.error('Error:', error));
        }, 300);
    });
    
    // Búsqueda de usuarios
    let timeoutUsuarios;
    document.getElementById('buscarUsuario').addEventListener('input', function() {
        clearTimeout(timeoutUsuarios);
        const query = this.value;
        
        if (query.length < 2) {
            document.getElementById('resultadosUsuarios').innerHTML = '';
            return;
        }
        
        timeoutUsuarios = setTimeout(() => {
            fetch(`/legajos/red-contactos/buscar-usuarios/?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    let html = '';
                    data.usuarios.forEach(usuario => {
                        html += `
                            <div class="list-group-item list-group-item-action" onclick="seleccionarUsuario(${usuario.id}, '${usuario.nombre_completo}')">
                                <strong>${usuario.nombre_completo}</strong><br>
                                <small>${usuario.username} ${usuario.email ? '• ' + usuario.email : ''}</small>
                            </div>
                        `;
                    });
                    document.getElementById('resultadosUsuarios').innerHTML = html ? `<div class="list-group">${html}</div>` : '';
                })
                .catch(error => console.error('Error:', error));
        }, 300);
    });
}

// Seleccionar ciudadano
function seleccionarCiudadano(id, nombre) {
    document.getElementById('ciudadanoVinculadoId').value = id;
    document.getElementById('buscarCiudadano').value = nombre;
    document.getElementById('resultadosCiudadanos').innerHTML = '';
}

// Seleccionar usuario
function seleccionarUsuario(id, nombre) {
    document.getElementById('usuarioId').value = id;
    document.getElementById('buscarUsuario').value = nombre;
    document.getElementById('resultadosUsuarios').innerHTML = '';
}

// Configurar formularios
function configurarFormularios() {
    // Formulario vínculo
    document.getElementById('formVinculo').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        fetch(`/legajos/${legajoId}/red-contactos/vinculos/crear/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('modalVinculo')).hide();
                this.reset();
                cargarVinculos();
                mostrarExito(data.message);
            } else {
                mostrarError(data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            mostrarError('Error al crear vínculo');
        });
    });
    
    // Formulario profesional
    document.getElementById('formProfesional').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        fetch(`/legajos/${legajoId}/red-contactos/profesionales/crear/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('modalProfesional')).hide();
                this.reset();
                cargarProfesionales();
                mostrarExito(data.message);
            } else {
                mostrarError(data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            mostrarError('Error al asignar profesional');
        });
    });
    
    // Formulario emergencia
    document.getElementById('formEmergencia').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        fetch(`/legajos/${legajoId}/red-contactos/emergencias/crear/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('modalEmergencia')).hide();
                this.reset();
                cargarEmergencias();
                mostrarExito(data.message);
            } else {
                mostrarError(data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            mostrarError('Error al crear contacto de emergencia');
        });
    });
}

// Abrir modales
function abrirModalVinculo() {
    document.getElementById('formVinculo').reset();
    document.getElementById('resultadosCiudadanos').innerHTML = '';
    new bootstrap.Modal(document.getElementById('modalVinculo')).show();
}

function abrirModalProfesional() {
    document.getElementById('formProfesional').reset();
    document.getElementById('resultadosUsuarios').innerHTML = '';
    new bootstrap.Modal(document.getElementById('modalProfesional')).show();
}

function abrirModalEmergencia() {
    document.getElementById('formEmergencia').reset();
    new bootstrap.Modal(document.getElementById('modalEmergencia')).show();
}

// Utilidades
function getEstadoBadgeClass(estado) {
    const classes = {
        'ACTIVO': 'bg-success',
        'EGRESADO': 'bg-secondary',
        'DERIVADO': 'bg-warning',
        'ABANDONO': 'bg-danger',
        'SUSPENDIDO': 'bg-dark'
    };
    return classes[estado] || 'bg-secondary';
}

function mostrarExito(mensaje) {
    alert(mensaje); // Implementar toast notification
}

function mostrarError(mensaje) {
    alert(mensaje); // Implementar toast notification
}
</script>
{% endblock %}