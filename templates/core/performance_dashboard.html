{% extends "includes/base.html" %}

{% block title %}Performance Dashboard{% endblock %}

{% block page_css %}
<!-- AdminLTE CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
.small-box {
    border-radius: 0.5rem;
    position: relative;
    display: block;
    margin-bottom: 20px;
    box-shadow: 0 1px 1px rgba(0,0,0,0.1);
}
.small-box > .inner {
    padding: 10px;
}
.small-box .icon {
    transition: all .3s linear;
    position: absolute;
    top: -10px;
    right: 10px;
    z-index: 0;
    font-size: 90px;
    color: rgba(0,0,0,0.15);
}
.small-box h3 {
    font-size: 2.2rem;
    font-weight: bold;
    margin: 0 0 10px 0;
    white-space: nowrap;
    padding: 0;
}
.small-box p {
    font-size: 1rem;
}
.bg-info { background-color: #17a2b8 !important; color: white; }
.bg-success { background-color: #28a745 !important; color: white; }
.bg-warning { background-color: #ffc107 !important; color: white; }
.bg-danger { background-color: #dc3545 !important; color: white; }

.info-box {
    display: block;
    min-height: 90px;
    background: #fff;
    width: 100%;
    box-shadow: 0 1px 1px rgba(0,0,0,0.1);
    border-radius: 0.5rem;
    margin-bottom: 15px;
}
.info-box .info-box-icon {
    border-top-left-radius: 0.5rem;
    border-top-right-radius: 0;
    border-bottom-right-radius: 0;
    border-bottom-left-radius: 0.5rem;
    display: block;
    float: left;
    height: 90px;
    width: 90px;
    text-align: center;
    font-size: 45px;
    line-height: 90px;
    background: rgba(0,0,0,0.2);
}
.info-box .info-box-content {
    padding: 5px 10px;
    margin-left: 90px;
}
.info-box .info-box-text {
    text-transform: uppercase;
    font-weight: bold;
    font-size: 14px;
}
.info-box .info-box-number {
    display: block;
    font-weight: bold;
    font-size: 18px;
}

.card {
    position: relative;
    display: flex;
    flex-direction: column;
    min-width: 0;
    word-wrap: break-word;
    background-color: #fff;
    background-clip: border-box;
    border: 0 solid rgba(0,0,0,.125);
    border-radius: 0.5rem;
    box-shadow: 0 0 1px rgba(0,0,0,.125), 0 1px 3px rgba(0,0,0,.2);
    margin-bottom: 1rem;
}
.card-header {
    padding: 0.75rem 1.25rem;
    margin-bottom: 0;
    background-color: transparent;
    border-bottom: 0 solid rgba(0,0,0,.125);
}
.card-title {
    float: left;
    font-size: 1.1rem;
    font-weight: 400;
    margin: 0;
}
.card-body {
    flex: 1 1 auto;
    min-height: 1px;
    padding: 1.25rem;
}

.alert {
    position: relative;
    padding: 0.75rem 1.25rem;
    margin-bottom: 1rem;
    border: 1px solid transparent;
    border-radius: 0.375rem;
}
.alert-success {
    color: #155724;
    background-color: #d4edda;
    border-color: #c3e6cb;
}
.alert-warning {
    color: #856404;
    background-color: #fff3cd;
    border-color: #ffeaa7;
}
.alert-danger {
    color: #721c24;
    background-color: #f8d7da;
    border-color: #f5c6cb;
}

.content-header {
    padding: 15px 0.5rem;
}
.breadcrumb {
    display: flex;
    flex-wrap: wrap;
    padding: 0.75rem 1rem;
    margin-bottom: 1rem;
    list-style: none;
    background-color: transparent;
    border-radius: 0.375rem;
}
.breadcrumb-item + .breadcrumb-item::before {
    display: inline-block;
    padding-right: 0.5rem;
    color: #6c757d;
    content: "/";
}
.breadcrumb-item.active {
    color: #6c757d;
}

.badge {
    display: inline-block;
    padding: 0.25em 0.4em;
    font-size: 75%;
    font-weight: 700;
    line-height: 1;
    text-align: center;
    white-space: nowrap;
    vertical-align: baseline;
    border-radius: 0.375rem;
}
.badge-secondary {
    color: #fff;
    background-color: #6c757d;
}

code {
    font-size: 87.5%;
    color: #e83e8c;
    word-wrap: break-word;
    background-color: #f8f9fa;
    padding: 0.2rem 0.4rem;
    border-radius: 0.375rem;
}
</style>
{% endblock %}

{% block main-content %}
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1>Performance Dashboard</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="/">Inicio</a></li>
                    <li class="breadcrumb-item active">Performance</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<section class="content">
    <div class="container-fluid">
        <!-- Métricas principales -->
        <div class="row">
            <div class="col-lg-3 col-6">
                <div class="small-box bg-info">
                    <div class="inner">
                        <h3 id="cpu-usage">--</h3>
                        <p>CPU Usage (%)</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-microchip"></i>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-6">
                <div class="small-box bg-success">
                    <div class="inner">
                        <h3 id="memory-usage">--</h3>
                        <p>Memory (%)</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-memory"></i>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-6">
                <div class="small-box bg-warning">
                    <div class="inner">
                        <h3 id="performance-score">--</h3>
                        <p>Performance Score</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-tachometer-alt"></i>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-6">
                <div class="small-box bg-danger">
                    <div class="inner">
                        <h3 id="total-queries">--</h3>
                        <p>Total Queries</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-database"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alertas -->
        <div class="row">
            <div class="col-md-6">
                <div class="info-box">
                    <span class="info-box-icon bg-warning" id="n1-icon"><i class="fas fa-exclamation-triangle"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Problemas N+1</span>
                        <span class="info-box-number" id="n1-status">--</span>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="info-box">
                    <span class="info-box-icon bg-danger" id="slow-icon"><i class="fas fa-clock"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Queries Lentas</span>
                        <span class="info-box-number" id="slow-queries">--</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Botón de Pruebas Automáticas -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Pruebas Automáticas de Fase 2</h3>
                    </div>
                    <div class="card-body text-center">
                        <button id="run-tests-btn" class="btn btn-primary btn-lg">
                            <i class="fas fa-play"></i> Ejecutar Pruebas Automáticas
                        </button>
                        <p class="mt-2 text-muted">Ejecuta análisis completo de índices, particionamiento y optimización</p>
                        
                        <!-- Resultados de Pruebas -->
                        <div id="test-results" class="mt-4" style="display: none;">
                            <h5>Resultados de Pruebas:</h5>
                            <div id="test-summary" class="alert" role="alert"></div>
                            <div id="test-details"></div>
                            <div id="test-recommendations"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Paneles -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Recomendaciones</h3>
                    </div>
                    <div class="card-body">
                        <div id="recommendations-list">
                            <div class="text-center">
                                <i class="fas fa-spinner fa-spin"></i> Cargando...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Análisis de Queries</h3>
                    </div>
                    <div class="card-body">
                        <div id="query-patterns">
                            <div class="text-center">
                                <i class="fas fa-spinner fa-spin"></i> Cargando...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Sugerencias de Optimización</h3>
                    </div>
                    <div class="card-body">
                        <div id="optimization-suggestions">
                            <div class="text-center">
                                <i class="fas fa-spinner fa-spin"></i> Cargando...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
function updateDashboard() {
    // System metrics
    fetch('/system-metrics-api/')
        .then(response => response.json())
        .then(data => {
            if (data.system && !data.system.error) {
                document.getElementById('cpu-usage').textContent = data.system.cpu.percent.toFixed(1);
                document.getElementById('memory-usage').textContent = data.system.memory.percent.toFixed(1);
            }
        })
        .catch(error => console.error('System metrics error:', error));
    
    // Performance data
    fetch('/performance-api/')
        .then(response => response.json())
        .then(data => {
            document.getElementById('performance-score').textContent = data.performance_score;
            document.getElementById('total-queries').textContent = data.total_queries;
            
            // N+1 status
            const n1Status = data.n1_detected ? 'SÍ' : 'NO';
            const n1IconClass = data.n1_detected ? 'bg-warning' : 'bg-success';
            document.getElementById('n1-status').textContent = n1Status;
            document.getElementById('n1-icon').className = `info-box-icon ${n1IconClass}`;
            
            // Slow queries
            const slowCount = data.slow_queries_count;
            const slowIconClass = slowCount > 0 ? 'bg-danger' : 'bg-success';
            document.getElementById('slow-queries').textContent = slowCount;
            document.getElementById('slow-icon').className = `info-box-icon ${slowIconClass}`;
            
            updateRecommendations(data.recommendations);
        })
        .catch(error => console.error('Performance API error:', error));
    
    // Query analysis
    fetch('/query-analysis-api/')
        .then(response => response.json())
        .then(data => {
            updateQueryPatterns(data);
        })
        .catch(error => console.error('Query analysis error:', error));
    
    // Optimization suggestions
    fetch('/optimization-suggestions-api/')
        .then(response => response.json())
        .then(data => {
            updateOptimizationSuggestions(data.suggestions);
        })
        .catch(error => console.error('Optimization suggestions error:', error));
}

function updateRecommendations(recommendations) {
    const container = document.getElementById('recommendations-list');
    
    if (recommendations.length === 0) {
        container.innerHTML = '<div class="alert alert-success"><i class="fas fa-check"></i> Sin problemas detectados</div>';
        return;
    }
    
    let html = '';
    recommendations.forEach(rec => {
        html += `
            <div class="alert alert-warning">
                <strong>${rec.type}:</strong> ${rec.suggestion}<br>
                <small>Ocurrencias: ${rec.count}</small>
            </div>
        `;
    });
    container.innerHTML = html;
}

function updateQueryPatterns(data) {
    const container = document.getElementById('query-patterns');
    let html = `<p><strong>Total Queries:</strong> ${data.query_count}</p>`;
    
    if (data.patterns.n1_detected) {
        html += '<div class="alert alert-danger">N+1 detectado: ' + data.patterns.similar_queries + ' queries similares</div>';
    } else {
        html += '<div class="alert alert-success">Sin patrones N+1</div>';
    }
    
    container.innerHTML = html;
}

function updateOptimizationSuggestions(suggestions) {
    const container = document.getElementById('optimization-suggestions');
    let html = '';
    
    suggestions.forEach(category => {
        html += `<h5>${category.category}</h5>`;
        category.items.forEach(item => {
            const alertClass = item.impact === 'High' ? 'alert-danger' : 'alert-warning';
            html += `
                <div class="alert ${alertClass}">
                    <strong>${item.title}</strong> <span class="badge badge-secondary">${item.impact}</span><br>
                    ${item.description}<br>
                    <code>${item.example}</code>
                </div>
            `;
        });
    });
    
    container.innerHTML = html;
}

// Manejar botón de pruebas automáticas
document.getElementById('run-tests-btn').addEventListener('click', function() {
    runAutomaticTests();
});

function runAutomaticTests() {
    const btn = document.getElementById('run-tests-btn');
    const resultsDiv = document.getElementById('test-results');
    const summaryDiv = document.getElementById('test-summary');
    const detailsDiv = document.getElementById('test-details');
    const recommendationsDiv = document.getElementById('test-recommendations');
    
    // Mostrar estado de carga
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ejecutando Pruebas...';
    resultsDiv.style.display = 'block';
    summaryDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ejecutando pruebas automáticas...';
    summaryDiv.className = 'alert alert-info';
    
    // Obtener CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch('/run-phase2-tests-api/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        // Restaurar botón
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-play"></i> Ejecutar Pruebas Automáticas';
        
        if (data.error) {
            summaryDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Error: ${data.error}`;
            summaryDiv.className = 'alert alert-danger';
            return;
        }
        
        // Mostrar resumen
        const summary = data.summary;
        const successClass = summary.all_passed ? 'alert-success' : 'alert-warning';
        const icon = summary.all_passed ? 'fa-check-circle' : 'fa-exclamation-triangle';
        
        summaryDiv.innerHTML = `
            <i class="fas ${icon}"></i> 
            <strong>Pruebas Completadas:</strong> ${summary.total_tests} pruebas en ${summary.total_duration_ms.toFixed(0)}ms<br>
            <strong>Performance Score:</strong> ${summary.performance_score}/100<br>
            <strong>Sugerencias de Índices:</strong> ${summary.index_suggestions}<br>
            <strong>Particiones Activas:</strong> ${summary.active_partitions}<br>
            <strong>Queries Analizadas:</strong> ${summary.queries_analyzed}
        `;
        summaryDiv.className = `alert ${successClass}`;
        
        // Mostrar detalles de pruebas
        let detailsHtml = '<h6>Detalles de Pruebas:</h6><div class="row">';
        data.tests_executed.forEach(test => {
            const statusIcon = test.status === 'success' ? 'fa-check text-success' : 'fa-times text-danger';
            const cardClass = test.status === 'success' ? 'card-success' : test.status === 'warning' ? 'card-warning' : 'card-primary';
            detailsHtml += `
                <div class="col-md-6 mb-2">
                    <div class="card card-outline ${cardClass}">
                        <div class="card-body p-2">
                            <i class="fas ${statusIcon}"></i> <strong>${test.test}</strong><br>
                            <small class="text-muted">${test.result} (${test.duration_ms.toFixed(0)}ms)</small>
                            ${test.details ? `<br><small class="text-info">Detalles disponibles</small>` : ''}
                        </div>
                    </div>
                </div>
            `;
        });
        detailsHtml += '</div>';
        detailsDiv.innerHTML = detailsHtml;
        
        // Mostrar recomendaciones
        if (data.recommendations && data.recommendations.length > 0) {
            let recHtml = '<h6>Recomendaciones:</h6>';
            data.recommendations.forEach(rec => {
                const alertClass = rec.type === 'error' ? 'alert-danger' : rec.type === 'warning' ? 'alert-warning' : rec.type === 'success' ? 'alert-success' : 'alert-info';
                const icon = rec.type === 'error' ? 'fa-exclamation-circle' : rec.type === 'warning' ? 'fa-exclamation-triangle' : rec.type === 'success' ? 'fa-check-circle' : 'fa-info-circle';
                recHtml += `
                    <div class="alert ${alertClass} p-3 mb-3">
                        <i class="fas ${icon}"></i> <strong>${rec.title}:</strong><br>
                        <span class="text-dark">${rec.message}</span>
                        ${rec.action ? `<br><small class="text-muted"><strong>Acción:</strong> <code>${rec.action}</code></small>` : ''}
                    </div>
                `;
            });
            recommendationsDiv.innerHTML = recHtml;
        } else {
            recommendationsDiv.innerHTML = '<div class="alert alert-success p-2"><i class="fas fa-thumbs-up"></i> ¡Todo funciona correctamente!</div>';
        }
        
        // Actualizar dashboard después de las pruebas
        setTimeout(updateDashboard, 2000);
    })
    .catch(error => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-play"></i> Ejecutar Pruebas Automáticas';
        summaryDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Error ejecutando pruebas: ${error}`;
        summaryDiv.className = 'alert alert-danger';
        console.error('Error:', error);
    });
}

setInterval(updateDashboard, 30000);
updateDashboard();
</script>
{% endblock %}