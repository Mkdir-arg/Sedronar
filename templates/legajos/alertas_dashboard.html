{% extends "includes/base.html" %}
{% load static %}

{% block title %}Dashboard de Alertas{% endblock %}

{% block page_css %}
<style>
.alerta-card {
    transition: all 0.3s ease;
}
.alerta-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}
.alerta-critica {
    border-left: 4px solid #dc2626;
    background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
}
.alerta-alta {
    border-left: 4px solid #ea580c;
    background: linear-gradient(135deg, #fff7ed 0%, #fed7aa 100%);
}
.alerta-media {
    border-left: 4px solid #ca8a04;
    background: linear-gradient(135deg, #fefce8 0%, #fef3c7 100%);
}
.pulse-animation {
    animation: pulse 2s infinite;
}
@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}
</style>
{% endblock %}

{% block main-content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8" x-data="alertasDashboard()">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 flex items-center">
                    <i class="fas fa-exclamation-triangle text-red-500 mr-3 pulse-animation"></i>
                    Dashboard de Alertas
                </h1>
                <p class="text-gray-600 mt-2">Monitoreo en tiempo real del sistema</p>
            </div>
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-2">
                    <div id="websocket-status" class="w-3 h-3 rounded-full bg-gray-400"></div>
                    <span class="text-sm text-gray-600">Estado WebSocket</span>
                </div>
                <button @click="refreshAlertas()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="fas fa-sync-alt mr-2"></i>Actualizar
                </button>
            </div>
        </div>
    </div>

    <!-- Estadísticas -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-red-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Alertas Críticas</p>
                    <p class="text-3xl font-bold text-red-600">{{ stats.criticas }}</p>
                </div>
                <div class="bg-red-100 rounded-full p-3">
                    <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-orange-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Alertas Altas</p>
                    <p class="text-3xl font-bold text-orange-600">{{ stats.altas }}</p>
                </div>
                <div class="bg-orange-100 rounded-full p-3">
                    <i class="fas fa-exclamation-circle text-orange-600 text-xl"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-yellow-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Alertas Medias</p>
                    <p class="text-3xl font-bold text-yellow-600">{{ stats.medias }}</p>
                </div>
                <div class="bg-yellow-100 rounded-full p-3">
                    <i class="fas fa-info-circle text-yellow-600 text-xl"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Total Activas</p>
                    <p class="text-3xl font-bold text-blue-600">{{ stats.total }}</p>
                </div>
                <div class="bg-blue-100 rounded-full p-3">
                    <i class="fas fa-bell text-blue-600 text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Alertas Críticas -->
    {% if alertas_criticas %}
    <div class="mb-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-4 flex items-center">
            <i class="fas fa-fire text-red-500 mr-2"></i>
            Alertas Críticas
        </h2>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            {% for alerta in alertas_criticas %}
            <div class="alerta-card alerta-critica rounded-xl p-6 shadow-lg" data-alerta-id="{{ alerta.id }}">
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-exclamation-triangle text-red-600 mr-2"></i>
                            <h3 class="font-bold text-gray-900">{{ alerta.ciudadano.nombre_completo }}</h3>
                        </div>
                        <p class="text-red-700 font-medium mb-2">{{ alerta.get_tipo_display }}</p>
                        <p class="text-gray-700 text-sm mb-3">{{ alerta.mensaje }}</p>
                        <div class="flex items-center text-xs text-gray-500">
                            <i class="fas fa-clock mr-1"></i>
                            {{ alerta.creado|date:"d/m/Y H:i" }}
                            {% if alerta.legajo %}
                            <span class="ml-3">
                                <i class="fas fa-folder mr-1"></i>
                                Legajo #{{ alerta.legajo.codigo }}
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="flex flex-col space-y-2 ml-4">
                        {% if alerta.legajo %}
                        <a href="/legajos/{{ alerta.legajo.id }}/" class="bg-red-600 text-white px-3 py-1 rounded text-xs hover:bg-red-700 transition-colors">
                            Ver Legajo
                        </a>
                        {% endif %}
                        <button @click="cerrarAlerta({{ alerta.id }})" class="bg-gray-600 text-white px-3 py-1 rounded text-xs hover:bg-gray-700 transition-colors">
                            Cerrar
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Alertas Altas y Medias -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Alertas Altas -->
        {% if alertas_altas %}
        <div>
            <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-exclamation-circle text-orange-500 mr-2"></i>
                Alertas Altas
            </h2>
            <div class="space-y-4">
                {% for alerta in alertas_altas %}
                <div class="alerta-card alerta-alta rounded-lg p-4 shadow" data-alerta-id="{{ alerta.id }}">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <h4 class="font-medium text-gray-900">{{ alerta.ciudadano.nombre_completo }}</h4>
                            <p class="text-orange-700 text-sm">{{ alerta.mensaje }}</p>
                            <p class="text-xs text-gray-500 mt-1">{{ alerta.creado|date:"d/m/Y H:i" }}</p>
                        </div>
                        <button @click="cerrarAlerta({{ alerta.id }})" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Alertas Medias -->
        {% if alertas_medias %}
        <div>
            <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-info-circle text-yellow-500 mr-2"></i>
                Alertas Medias
            </h2>
            <div class="space-y-4">
                {% for alerta in alertas_medias %}
                <div class="alerta-card alerta-media rounded-lg p-4 shadow" data-alerta-id="{{ alerta.id }}">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <h4 class="font-medium text-gray-900">{{ alerta.ciudadano.nombre_completo }}</h4>
                            <p class="text-yellow-700 text-sm">{{ alerta.mensaje }}</p>
                            <p class="text-xs text-gray-500 mt-1">{{ alerta.creado|date:"d/m/Y H:i" }}</p>
                        </div>
                        <button @click="cerrarAlerta({{ alerta.id }})" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Estado sin alertas -->
    {% if not alertas_criticas and not alertas_altas and not alertas_medias %}
    <div class="text-center py-12">
        <div class="bg-green-100 rounded-full w-24 h-24 flex items-center justify-center mx-auto mb-4">
            <i class="fas fa-check-circle text-green-600 text-4xl"></i>
        </div>
        <h3 class="text-xl font-medium text-gray-900 mb-2">¡Todo en orden!</h3>
        <p class="text-gray-600">No hay alertas activas en el sistema</p>
    </div>
    {% endif %}
</div>

<script>
function alertasDashboard() {
    return {
        cerrarAlerta(alertaId) {
            fetch(`/legajos/alertas/${alertaId}/cerrar/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const alertaElement = document.querySelector(`[data-alerta-id="${alertaId}"]`);
                    if (alertaElement) {
                        alertaElement.style.transition = 'all 0.3s ease';
                        alertaElement.style.opacity = '0';
                        alertaElement.style.transform = 'translateX(100%)';
                        setTimeout(() => {
                            alertaElement.remove();
                        }, 300);
                    }
                    this.updateCounter();
                }
            });
        },
        
        refreshAlertas() {
            window.location.reload();
        },
        
        updateCounter() {
            fetch('/legajos/alertas/count/')
                .then(response => response.json())
                .then(data => {
                    const counter = document.querySelector('#alertas-counter');
                    if (counter) {
                        counter.textContent = data.count;
                        counter.style.display = data.count > 0 ? 'inline' : 'none';
                    }
                });
        }
    }
}
</script>
{% endblock %}